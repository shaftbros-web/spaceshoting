<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>スペースシューティング v2</title>
  <style>
    body { margin: 0; background: #0b0f14; overflow: hidden; color: #fff; font-family: sans-serif; }
    canvas { display: block; margin: 0 auto; background: #0b0f14; }
    #ui { position: fixed; top: 8px; left: 8px; right: 8px; display: flex; justify-content: space-between; font-size: 18px; }
    .panel { background: rgba(0,0,0,0.6); padding: 4px 8px; border-radius: 8px; }
  </style>
</head>
<body>
  <div id="ui">
    <div class="panel" id="score">SCORE 0</div>
    <div class="panel" id="time">60.0s</div>
    <div class="panel" id="life">❤❤❤</div>
    <div class="panel" id="best">BEST 0</div>
  </div>
  <canvas id="game"></canvas>
  <script>
    const cvs = document.getElementById('game');
    const ctx = cvs.getContext('2d');
    let W = window.innerWidth, H = window.innerHeight;
    cvs.width = W; cvs.height = H;

    let x = W/2, y0 = H-80;
    let bullets = [];
    let enemies = [];
    let bosses = [];
    let midBoss = null;
    let score = 0, best = 0;
    let life = 3;
    let time = 60*60;
    let keys = {};
    let level = 1;
    const baseV = -8;
    const sp = 6;

    document.addEventListener('keydown', e=> keys[e.key] = true);
    document.addEventListener('keyup', e=> keys[e.key] = false);

    // 自機のショット（ワイド対応修正版）
    const shot=(xpos,a=0)=>{
      if(a===0){
        bullets.push({x:xpos, y:y0, v:baseV});
      } else {
        const dirX = Math.sin(a);
        const dirY = -Math.cos(a);
        bullets.push({x:xpos, y:y0, vx:dirX*sp, vy:dirY*sp});
      }
    };

    function spawnEnemy(){
      enemies.push({x:Math.random()*W, y:-20, v:2});
    }

    function spawnBoss(){
      bosses.push({x:W/2, y:100, hp:50});
    }

    function spawnMidBoss(){
      midBoss = {x:W/2, y:80, hp:30};
    }

    function update(){
      // 移動
      if(keys['ArrowLeft']) x -= 6;
      if(keys['ArrowRight']) x += 6;
      if(x<20) x=20; if(x>W-20) x=W-20;

      // ショット
      if(keys[' ']){
        if(frame%10===0){
          if(level===1) shot(x);
          if(level===2) {shot(x-10); shot(x+10);}
          if(level===3) {shot(x); shot(x-15); shot(x+15);}
          if(level===4) {shot(x); shot(x-20); shot(x+20); shot(x,0.2); shot(x,-0.2);}
          if(level>=5) {shot(x); shot(x-25); shot(x+25); shot(x,0.3); shot(x,-0.3);}
        }
      }

      bullets.forEach(b=>{
        if(b.v){b.y+=b.v;} else {b.x+=b.vx; b.y+=b.vy;}
      });
      bullets=bullets.filter(b=> b.y>-20 && b.y<H+20 && b.x>0 && b.x<W);

      enemies.forEach(e=> e.y+=e.v);
      enemies=enemies.filter(e=> e.y<H+20);

      // 敵衝突
      enemies.forEach((e,ei)=>{
        bullets.forEach((b,bi)=>{
          if(Math.abs(e.x-b.x)<15 && Math.abs(e.y-b.y)<15){
            enemies.splice(ei,1);
            bullets.splice(bi,1);
            score+=10;
            if(score%100===0 && level<5) level++;
          }
        });
      });

      // 中ボス出現
      if(time===40*60 && !midBoss){ spawnMidBoss(); }

      if(midBoss){
        midBoss.y+=Math.sin(frame/30)*2;
        bullets.forEach((b,bi)=>{
          if(Math.abs(midBoss.x-b.x)<40 && Math.abs(midBoss.y-b.y)<40){
            midBoss.hp--; bullets.splice(bi,1);
            if(midBoss.hp<=0) midBoss=null, score+=200;
          }
        });
      }

      // ボス出現（最後）
      if(time===20*60 && bosses.length===0){ spawnBoss(); }

      bosses.forEach((bo,bi)=>{
        bullets.forEach((b,bi2)=>{
          if(Math.abs(bo.x-b.x)<60 && Math.abs(bo.y-b.y)<60){
            bo.hp--; bullets.splice(bi2,1);
            if(bo.hp<=0) { bosses.splice(bi,1); score+=500; }
          }
        });
      });

      time--;
      if(time<=0) endGame();
    }

    function draw(){
      ctx.clearRect(0,0,W,H);
      ctx.fillStyle='skyblue';
      ctx.beginPath();
      ctx.moveTo(x, y0-20);
      ctx.lineTo(x-15,y0+15);
      ctx.lineTo(x+15,y0+15);
      ctx.closePath();
      ctx.fill();

      ctx.fillStyle='deepskyblue';
      bullets.forEach(b=> ctx.fillRect(b.x-2,b.y-10,4,10));

      ctx.fillStyle='violet';
      enemies.forEach(e=> ctx.beginPath(), ctx.arc(e.x,e.y,15,0,Math.PI*2), ctx.fill());

      if(midBoss){
        ctx.fillStyle='orange';
        ctx.beginPath();
        ctx.arc(midBoss.x,midBoss.y,40,0,Math.PI*2);
        ctx.fill();
      }

      bosses.forEach(bo=>{
        ctx.fillStyle='red';
        ctx.beginPath();
        ctx.arc(bo.x,bo.y,60,0,Math.PI*2);
        ctx.fill();
      });

      document.getElementById('score').innerText = `SCORE ${score}`;
      document.getElementById('time').innerText = (time/60).toFixed(1)+"s";
      document.getElementById('life').innerText = "❤".repeat(life);
      document.getElementById('best').innerText = `BEST ${best}`;
    }

    function endGame(){
      best = Math.max(best,score);
      alert("Game Over! SCORE: "+score);
      document.location.reload();
    }

    let frame=0;
    setInterval(()=>{ frame++; if(frame%60===0) spawnEnemy(); update(); draw(); },1000/60);
  </script>
</body>
</html>
